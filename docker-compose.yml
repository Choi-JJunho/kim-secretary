services:
  secretary:
    image: docker.io/junho5336/kim-secretary:prod
    container_name: kim-secretary
    restart: unless-stopped

    volumes:
      # Claude CLI 인증 정보 마운트 (호스트의 .claude 디렉토리)
      # 읽기/쓰기 권한 필요 (CLI가 debug 로그 작성)
      - /root/.claude:/root/.claude
      # Gemini CLI 인증 정보 마운트 (호스트의 .gemini 디렉토리)
      - /root/.gemini:/root/.gemini
      # junogarden-web Git 저장소 마운트 (업무일지 발행용)
      - /root/junogarden-web:/app/junogarden-web:rw
      # Resume evaluator 데이터 저장
      - /root/kim-secretary-data/resume_evaluator:/app/data/resume_evaluator:rw
      - /root/kim-secretary-data/resume_evaluator/cafe24:/app/data/resume_evaluator/cafe24:rw
      - /root/kim-secretary-data/resume_evaluator/wanted:/app/data/resume_evaluator/wanted:rw

    environment:
      # Application Configuration
      PYTHONUNBUFFERED: 1
      PYTHONDONTWRITEBYTECODE: 1
      TZ: Asia/Seoul

      # Slack Configuration
      SLACK_BOT_TOKEN: ${SLACK_BOT_TOKEN}
      SLACK_APP_TOKEN: ${SLACK_APP_TOKEN}
      SLACK_WAKE_UP_CHANNEL_ID: ${SLACK_WAKE_UP_CHANNEL_ID}
      SLACK_WORK_LOG_REPORT_CHANNEL_ID: ${SLACK_WORK_LOG_REPORT_CHANNEL_ID}
      SLACK_WORK_LOG_WEBHOOK_CHANNEL_ID: ${SLACK_WORK_LOG_WEBHOOK_CHANNEL_ID}
      SLACK_REPORT_CHANNEL_ID: ${SLACK_REPORT_CHANNEL_ID}
      CAFE24_RESUME_FEEDBACK_CHANNEL_ID: ${CAFE24_RESUME_FEEDBACK_CHANNEL_ID}
      SLACK_RESUME_FEEDBACK_CHANNEL_ID: ${SLACK_RESUME_FEEDBACK_CHANNEL_ID}

      # Notion Configuration
      NOTION_API_KEY: ${NOTION_API_KEY}
      NOTION_WAKE_UP_DATABASE_ID: ${NOTION_WAKE_UP_DATABASE_ID}
      NOTION_WORK_DATABASE_MAPPING: ${NOTION_WORK_DATABASE_MAPPING}
      NOTION_USER_DATABASE_MAPPING: ${NOTION_USER_DATABASE_MAPPING}

      # AI Provider - Gemini (CLI 방식, API_KEY 불필요)
      GEMINI_MODEL: ${GEMINI_MODEL:-gemini-2.5-pro}
      GEMINI_TIMEOUT: ${GEMINI_TIMEOUT:-5000}

      # Claude Code
      CLAUDE_CODE_ENABLED: "true"
      CLAUDE_CODE_TIMEOUT: "300"

      # GitHub Configuration (업무일지 발행용)
      JUNOGARDEN_REPO_PATH: /app/junogarden-web

    # Health check
    healthcheck:
      test:
        - CMD
        - python
        - -c
        - import sys; sys.exit(0)
      interval: 30s
      timeout: 10s
      start_period: 40s
      retries: 3

    # Logging configuration
    logging:
      driver: json-file
      options:
        max-size: 10m
        max-file: "3"

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M

    networks:
      - supabase_default

networks:
  supabase_default:
    external: true
