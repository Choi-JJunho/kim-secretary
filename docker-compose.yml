version: '3.8'

services:
  secretary:
    image: docker.io/junho5336/kim-secretary:prod
    container_name: kim-secretary
    restart: unless-stopped

    volumes:
      # Claude CLI 인증 정보 마운트 (호스트의 .claude 디렉토리)
      # 읽기/쓰기 권한 필요 (CLI가 debug 로그 작성)
      - /root/.claude:/root/.claude

    environment:
      # Application Configuration
      PYTHONUNBUFFERED: 1
      PYTHONDONTWRITEBYTECODE: 1
      TZ: Asia/Seoul

      # Slack Configuration
      SLACK_BOT_TOKEN: ${SLACK_BOT_TOKEN}
      SLACK_APP_TOKEN: ${SLACK_APP_TOKEN}
      SLACK_WAKE_UP_CHANNEL_ID: ${SLACK_WAKE_UP_CHANNEL_ID}
      SLACK_WORK_LOG_REPORT_CHANNEL_ID: ${SLACK_WORK_LOG_REPORT_CHANNEL_ID}
      SLACK_WORK_LOG_WEBHOOK_CHANNEL_ID: ${SLACK_WORK_LOG_WEBHOOK_CHANNEL_ID}

      # Notion Configuration
      NOTION_API_KEY: ${NOTION_API_KEY}
      NOTION_WAKE_UP_DATABASE_ID: ${NOTION_WAKE_UP_DATABASE_ID}
      NOTION_USER_DATABASE_MAPPING: ${NOTION_USER_DATABASE_MAPPING}
      SLACK_REPORT_CHANNEL_ID: ${SLACK_REPORT_CHANNEL_ID:-}

      # AI Provider - Gemini
      GEMINI_API_KEY: ${GEMINI_API_KEY:-}
      GEMINI_MODEL: ${GEMINI_MODEL:-gemini-2.0-flash}
      GEMINI_TIMEOUT: ${GEMINI_TIMEOUT:-5000}

    # Health check
    healthcheck:
      test: ["CMD", "python", "-c", "import sys; sys.exit(0)"]
      interval: 30s
      timeout: 10s
      start_period: 40s
      retries: 3

    # Logging configuration
    logging:
      driver: json-file
      options:
        max-size: 10m
        max-file: "3"

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M

    networks:
      - supabase_default

networks:
  supabase_default:
    external: true
